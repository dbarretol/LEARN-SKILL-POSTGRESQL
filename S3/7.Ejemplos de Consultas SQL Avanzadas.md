# VII. Ejemplos de Consultas SQL Avanzadas

En la gestión avanzada de bases de datos, son frecuentes:

- **Consultas de agregación** (`SUM`, `AVG`, `COUNT`, etc.).
- **Subconsultas** (consultas anidadas dentro de otras).
- Combinación de ambas para análisis más profundos.

A continuación se muestran ejemplos prácticos para reforzar comprensión y uso.

---

## 1. Consultas de Agregación

Las consultas de agregación se emplean para:

- Obtener **totales**, **promedios**, **conteos**.
- Resumir información por **grupo** (`GROUP BY`).

Supongamos las tablas:

```sql
CREATE TABLE categorias (
    id          SERIAL PRIMARY KEY,
    nombre      TEXT NOT NULL
);

CREATE TABLE productos (
    id              SERIAL PRIMARY KEY,
    nombre          TEXT NOT NULL,
    precio          NUMERIC(10,2) NOT NULL,
    categoria_id    INTEGER REFERENCES categorias(id)
);
```

### 1.1. Suma de productos por categoría

**Objetivo:** sumar el precio total de los productos por categoría.

```sql
SELECT
    c.nombre                    AS categoria,
    SUM(p.precio)               AS total,
    COUNT(p.id)                 AS cantidad_productos
FROM categorias c
JOIN productos p
    ON p.categoria_id = c.id
GROUP BY c.nombre
ORDER BY total DESC;
```

Puntos clave:

- `SUM(p.precio)` calcula el **importe total**.
- `COUNT(p.id)` cuenta los productos por categoría.
- `GROUP BY c.nombre` agrupa por categoría.
- `ORDER BY total DESC` ordena de mayor a menor total.

### 1.2. Filtro sobre agregados: `HAVING`

**Objetivo:** mostrar solo categorías con un total mayor a 10,000.

```sql
SELECT
    c.nombre        AS categoria,
    SUM(p.precio)   AS total
FROM categorias c
JOIN productos p
    ON p.categoria_id = c.id
GROUP BY c.nombre
HAVING SUM(p.precio) > 10000
ORDER BY total DESC;
```

- `HAVING` se usa para filtrar **después** de agrupar.

---

## 2. Subconsultas (Subqueries)

Una **subconsulta** es una consulta anidada dentro de otra.  
Se utilizan para:

- Calcular valores que luego se usan como condición.
- Seleccionar subconjuntos de datos.
- Verificar existencias (`EXISTS`), pertenencia (`IN`), etc.

### 2.1. Productos con precio mayor al promedio

**Objetivo:** obtener productos cuyo precio es **mayor al precio promedio** de todos los productos.

```sql
SELECT
    nombre,
    precio
FROM productos
WHERE precio > (
    SELECT AVG(precio)
    FROM productos
);
```

Explicación:

- La subconsulta `SELECT AVG(precio) FROM productos` calcula el **precio promedio**.
- La consulta externa devuelve solo los productos con `precio` superior a ese valor.

---

### 2.2. Productos en categorías con un mínimo de productos

**Objetivo:** listar productos que pertenecen a categorías con **al menos 5 productos**.

```sql
SELECT
    p.nombre,
    p.precio,
    c.nombre AS categoria
FROM productos p
JOIN categorias c
    ON p.categoria_id = c.id
WHERE c.id IN (
    SELECT categoria_id
    FROM productos
    GROUP BY categoria_id
    HAVING COUNT(*) >= 5
);
```

- La subconsulta en `IN` obtiene los `categoria_id` con 5 o más productos.
- La consulta externa muestra solo los productos que pertenecen a esas categorías.

---

### 2.3. Uso de `EXISTS` para verificar existencia relacionada

**Objetivo:** obtener categorías que tengan al menos un producto con precio mayor a 1,000.

```sql
SELECT
    c.id,
    c.nombre
FROM categorias c
WHERE EXISTS (
    SELECT 1
    FROM productos p
    WHERE p.categoria_id = c.id
      AND p.precio > 1000
);
```

- `EXISTS` verifica si la subconsulta devuelve **al menos una fila**.
- Es eficiente cuando solo importa la **existencia**, no el detalle.

---

## 3. Resumen
- Las **consultas avanzadas**:
  - Usan **agregaciones** para obtener resúmenes de datos.
  - Usan **subconsultas** para comparar, filtrar y analizar información con mayor precisión.

