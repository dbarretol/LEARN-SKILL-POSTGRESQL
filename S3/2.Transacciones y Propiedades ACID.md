# II. Transacciones y Propiedades ACID en PostgreSQL

En esta sección se aborda el núcleo de la **integridad de datos** en PostgreSQL:  
las **transacciones** y las **propiedades ACID**, junto con el papel del **MVCC** en el control de concurrencia.

---

## 1. Concepto de Transacción

Una **transacción** es un **conjunto de operaciones SQL** que se ejecutan como una **unidad lógica indivisible**.  
Se utiliza, sobre todo, en operaciones de:

- **Inserción** (`INSERT`)
- **Consulta** (`SELECT`)
- **Actualización** (`UPDATE`)
- **Eliminación** (`DELETE`)

El objetivo principal es que estas operaciones se comporten de forma **coherente y segura**, cumpliendo las propiedades **ACID**.

### 1.1. Ejemplo básico de transacción

```sql
-- Iniciar una transacción
BEGIN;

INSERT INTO clientes (nombre, email)
VALUES ('Juan Pérez', 'juan.perez@example.com');

UPDATE cuentas
SET saldo = saldo - 100
WHERE id = 1;

UPDATE cuentas
SET saldo = saldo + 100
WHERE id = 2;

-- Confirmar todos los cambios
COMMIT;
```

Si algo falla en medio de la transacción, podemos **deshacer todo**:

```sql
BEGIN;

UPDATE cuentas
SET saldo = saldo - 100
WHERE id = 1;

-- Supongamos que aquí ocurre un error:
UPDATE cuentas
SET saldo = saldo + 100
WHERE id = 9999;  -- Cuenta inexistente

-- Deshacemos todos los cambios
ROLLBACK;
```

---

## 2. Propiedades Fundamentales: ACID

Las propiedades **ACID** (Atomicity, Consistency, Isolation, Durability) garantizan la **fiabilidad** de las transacciones y la **estabilidad** de los datos.

| Propiedad   | Descripción breve                                      |
|-------------|--------------------------------------------------------|
| Atomicidad  | Todo o nada: la transacción se completa o se deshace. |
| Consistencia| La BD pasa de un estado válido a otro estado válido.  |
| Aislamiento | Las transacciones no interfieren entre sí.             |
| Durabilidad | Lo confirmado no se pierde, incluso ante fallos.      |

---

### 2.1. Atomicidad (A) – “Todo o nada”

La **atomicidad** garantiza que **todas** las operaciones de una transacción se ejecutan correctamente o **ninguna** se aplica.

- Si algo falla:
  - Se descartan todos los cambios realizados en la transacción.
  - La base de datos vuelve al estado **anterior al `BEGIN`**.

**Ejemplo: transferencia bancaria**

```sql
BEGIN;

-- Restar de la cuenta origen
UPDATE cuentas
SET saldo = saldo - 500
WHERE id = 1;

-- Sumar a la cuenta destino
UPDATE cuentas
SET saldo = saldo + 500
WHERE id = 2;

-- Si ambas operaciones son correctas
COMMIT;
```

Si la segunda actualización falla (por ejemplo, la cuenta 2 no existe):

```sql
BEGIN;

UPDATE cuentas
SET saldo = saldo - 500
WHERE id = 1;

UPDATE cuentas
SET saldo = saldo + 500
WHERE id = 9999;  -- Error: cuenta inexistente

-- Ante el error, deshacemos todo
ROLLBACK;
```

Resultado: el saldo de la cuenta `1` **no cambia**.

---

### 2.2. Consistencia (C)

La **consistencia** asegura que, antes y después de una transacción, la base de datos se mantenga en un **estado válido**, respetando:

- Restricciones (`PRIMARY KEY`, `FOREIGN KEY`, `UNIQUE`, `CHECK`, `NOT NULL`, etc.).
- Reglas de negocio definidas.

**Ejemplo: restricción de clave primaria**

```sql
-- Tabla con clave primaria
CREATE TABLE usuarios (
    id      SERIAL PRIMARY KEY,
    email   TEXT UNIQUE NOT NULL
);

-- Inserción válida
INSERT INTO usuarios (email)
VALUES ('user@example.com');

-- Inserción inválida (email duplicado)
INSERT INTO usuarios (email)
VALUES ('user@example.com');  -- Violación de UNIQUE
```

La segunda inserción será rechazada, garantizando la **consistencia**.

---

### 2.3. Aislamiento (I) – Isolation

El **aislamiento** exige que las transacciones se ejecuten como si estuvieran **solas**, sin verse afectadas por otras transacciones concurrentes.

En PostgreSQL, esto se controla mediante **niveles de aislamiento**.

#### 2.3.1. Niveles de aislamiento en PostgreSQL

PostgreSQL soporta los siguientes niveles:

| Nivel             | Descripción                                                                 |
|-------------------|-----------------------------------------------------------------------------|
| `READ COMMITTED`  | (Por defecto) Solo ve datos **confirmados** por otras transacciones.       |
| `REPEATABLE READ` | Garantiza que las filas leídas no cambian durante la transacción.          |
| `SERIALIZABLE`    | Simula que las transacciones se ejecutan de forma estrictamente secuencial.|

> Nota: en PostgreSQL, `READ UNCOMMITTED` se trata internamente como `READ COMMITTED`.

#### 2.3.2. Ejemplo: configurar el nivel de aislamiento

```sql
BEGIN;

SET TRANSACTION ISOLATION LEVEL REPEATABLE READ;

SELECT * FROM productos WHERE id = 10;

-- Durante esta transacción, la misma consulta devolverá siempre
-- el mismo resultado, aunque otra transacción modifique esa fila.

COMMIT;
```

#### 2.3.3. Ejemplo conceptual de concurrencia

**Transacción A:**

```sql
BEGIN;
SET TRANSACTION ISOLATION LEVEL READ COMMITTED;

UPDATE productos
SET stock = stock - 1
WHERE id = 10;

-- (Aún sin COMMIT)
```

**Transacción B (ejecutándose al mismo tiempo):**

```sql
BEGIN;
SET TRANSACTION ISOLATION LEVEL READ COMMITTED;

SELECT stock
FROM productos
WHERE id = 10;

COMMIT;
```

En `READ COMMITTED`, la transacción B:

- **No** verá el cambio de A hasta que A haga `COMMIT`.
- Evita leer datos “a medio modificar”.

---

### 2.4. Durabilidad (D)

La **durabilidad** garantiza que, una vez ejecutado un `COMMIT`, los cambios:

- **Persisten** en la base de datos.
- No se pierden aunque:
  - Se apague el servidor.
  - Se produzca un fallo del sistema.

PostgreSQL logra esto mediante el **WAL** (*Write-Ahead Log*), donde primero registra los cambios en un log y luego los aplica a los datos.

**Ejemplo:**

```sql
BEGIN;

INSERT INTO logs_operaciones (descripcion, fecha)
VALUES ('Alta de usuario', NOW());

COMMIT;  -- A partir de aquí, el registro persiste incluso ante un apagón
```

---

## 3. Control de Concurrencia Multiversión (MVCC)

El **MVCC** (*Multiversion Concurrency Control*) es la técnica que PostgreSQL utiliza para:

- Permitir **múltiples transacciones concurrentes**.
- Evitar bloqueos de lectura innecesarios.
- Proporcionar a cada transacción una **vista consistente** de los datos.

### 3.1. Características principales de MVCC

- **Versionado de datos**  
  Cada `UPDATE` o `DELETE` no sobrescribe el registro original, sino que:
  - Marca la versión antigua como obsoleta para futuras transacciones.
  - Crea una **nueva versión** visible para las transacciones posteriores.

- **Lecturas sin bloqueo**  
  Las operaciones `SELECT`:
  - No bloquean las escrituras.
  - No son bloqueadas por ellas (en la mayoría de los casos), lo que mejora el rendimiento.

- **Visibilidad por transacción**  
  Cada transacción:
  - Ve únicamente las versiones de los datos que eran válidas en el momento en que **comenzó** (dependiendo del nivel de aislamiento).

### 3.2. Ejemplo ilustrativo de MVCC

Supongamos la tabla:

```sql
CREATE TABLE productos (
    id      SERIAL PRIMARY KEY,
    nombre  TEXT,
    stock   INTEGER
);

INSERT INTO productos (nombre, stock)
VALUES ('Teclado', 10);
```

**Transacción A:**

```sql
BEGIN;

UPDATE productos
SET stock = stock - 2
WHERE id = 1;

-- Aún no hace COMMIT
```

**Transacción B (iniciada después de A, en READ COMMITTED):**

```sql
BEGIN;

SELECT stock
FROM productos
WHERE id = 1;

COMMIT;
```

- Mientras A no haga `COMMIT`, B verá el `stock` original (`10`), **no** el `8`.
- Cuando A haga `COMMIT`, las transacciones futuras verán la nueva versión (`8`).

### 3.3. Limpieza de versiones antiguas: VACUUM

Con MVCC, las versiones antiguas de filas se van acumulando.  
PostgreSQL usa el comando `VACUUM` para limpiar versiones que ya no son visibles para ninguna transacción activa.

```sql
-- Limpieza manual de versiones obsoletas
VACUUM (VERBOSE, ANALYZE) productos;
```

En la práctica, PostgreSQL ejecuta procesos de **autovacuum** de forma automática, pero es importante conocer el comando para:

- Administración avanzada.
- Optimización de rendimiento.
- Mantenimiento de espacio en disco.

---

## 4. Resumen

- Una **transacción** es una unidad de trabajo que debe cumplir las propiedades **ACID**.
- **Atomicidad**: o se aplican todas las operaciones o ninguna.
- **Consistencia**: la base de datos siempre pasa por estados **válidos**.
- **Aislamiento**: las transacciones no se interfieren mutuamente en su lógica.
- **Durabilidad**: lo que se confirma, **permanece**.
- PostgreSQL implementa un potente control de concurrencia mediante **MVCC**, permitiendo:
  - Lecturas consistentes.
  - Alta concurrencia.
  - Menos bloqueos y mejor rendimiento.

Estos conceptos son la base para comprender temas más avanzados como **bloqueos explícitos**, **deadlocks**, y **ajuste fino de niveles de aislamiento**.