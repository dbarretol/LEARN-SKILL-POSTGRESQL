**V. Replicación y Alta Disponibilidad**

**A. Concepto de Replicación: Proceso de copiar datos a otra base de datos, a menudo como un espejo**

La replicación en PostgreSQL es un **proceso** mediante el cual se copian datos de una base de datos y se llevan a **otra base de datos**. Este proceso permite tener una copia de los datos, a menudo funcionando como un **espejo** que puede residir en otro equipo o en una red diferente. La replicación es crucial porque permite duplicar datos entre bases de datos de forma eficiente. La base de datos replicada puede tener el mismo nombre o uno diferente, lo cual es útil para conectarse en caso de que la principal falle, ayudando al restablecimiento del sistema si ocurre una caída.

**B. Tipos de Replicación**

Existen diferentes métodos de replicación en PostgreSQL:

**1. Streaming Replication (Tiempo Real)**
Esta técnica permite **replicar los cambios en tiempo real** desde la base de datos principal hacia una o más réplicas. La replicación *streaming* utiliza los **registros WAL** (Write-Ahead Log), también conocidos como *glob*.

*   *Funcionamiento:* La base de datos principal se encarga de enviar los registros WAL a las réplicas en tiempo real, y estas réplicas aplican dichos registros para **mantenerse sincronizadas**.
*   *Ventajas:* Ofrece **alta disponibilidad**, genera un **bajo impacto en el rendimiento**, y facilita un **desempeño de lectura distribuida**.
*   *Limitaciones:* Las réplicas pueden llegar a estar **ligeramente desincronizadas**, por lo que es necesario un **monitoreo constante** para prevenir la pérdida de datos.

**2. Replicación Síncrona**
Es una **variante de la replicación en tiempo real**. En este método, la base de datos principal **espera la confirmación de al menos una réplica** antes de que se pueda completar la transacción. Esto significa que la transacción no finaliza hasta que la réplica o las réplicas configuradas hayan recibido la confirmación de los registros.

**3. Replicación Asíncrona**
A diferencia de la síncrona, en la replicación asíncrona, la base de datos principal **no espera la confirmación de las réplicas** para completar la transacción antes de realizar la replicación.

**4. Replicación Lógica**
Este tipo de replicación permite copiar solo una **parte específica de la base de datos** (como ciertas tablas o esquemas) en lugar de duplicar toda la base de datos completa.

**C. Configuración y Verificación**

La replicación *streaming* es el tipo más utilizado. Su configuración requiere varios pasos:

1.  **Configuración del servidor principal:** Es necesario **modificar** el archivo de configuración `postgres.conf`.
2.  **Configuración del servidor principal:** También se debe **modificar** el archivo `pg_hda.conf`.
3.  **Reiniciar el servidor**.
4.  **Realización del respaldo entre bases**.
5.  **Configuración del servidor de réplica:** Para versiones a partir de la 12, se debe **crear un archivo `recovery.conf`**. Para la versión 13 en adelante, se puede utilizar la configuración **`stamping`** (Signa).
6.  **Verificación:** Una vez configurado, se debe comprobar el estado de la replicación en el servidor principal.
7.  **Promoción:** Finalmente, se debe verificar la replicación y realizar la **promoción de la replicación** (lanzar la configuración correspondiente).

**D. Herramientas de Alta Disponibilidad a Fallos (Failover)**

La alta disponibilidad y el *failover* son conceptos esenciales para asegurar que la base de datos pueda **continuar operando** incluso cuando se experimenten fallos. Existen herramientas que facilitan esta disponibilidad a fallos:

1.  **Patroni:** Es un **gestor de alta disponibilidad** especializado en PostgreSQL. Ofrece **fallos automáticos** y se encarga de la **supervisión de nodos**, pudiendo utilizar tecnologías como BPC o consulción.
2.  **PG Bouncer:** Actúa como un *pool* de conexiones para PostgreSQL. Su función principal es **ayudar a balancear la carga** de conexiones entre el servidor principal y las réplicas.
3.  **PG Pool 2:** Es una herramienta de *clustering* que proporciona soporte para ***failover* automático**, **balanceo de carga** y el manejo de conexiones.
4.  Otras herramientas mencionadas son **Pacemaker** (gestión de alta disponibilidad que proporciona fallos automáticos) y **Red NGR** (herramienta para automatizar la gestión y promoción de fallos en nodos).