## II. Administración y Herramientas Avanzadas: Copias de Seguridad y Restauración

La cuarta sesión del curso se centró en la **administración de PostgreSQL** y en el uso de **herramientas avanzadas** para:

- Realizar **copias de seguridad (backups)**.
- Ejecutar **procesos de restauración** de bases de datos.

---

## A. Métodos de Copia de Seguridad en PostgreSQL

En PostgreSQL se utilizan principalmente **dos enfoques de backup**:

1. **Backups lógicos** → `pg_dump` / `pg_dumpall`
2. **Backups físicos** → `pg_basebackup`

### 1. `pg_dump`: Backup lógico (script de la base de datos)

`pg_dump` es la herramienta más común para respaldar bases de datos en PostgreSQL.  
Genera un **script o archivo en formato especial** que contiene:

- La **estructura** (DDL) de la base de datos.
- Los **datos** (registros) de las tablas.

Es ideal para:

- **Migraciones** entre servidores.
- Respaldos “ligeros” y **altamente portables**.
- Replicar solo una base específica y no todo el clúster.

#### Ejemplos prácticos de `pg_dump`

> Supongamos que la base de datos se llama `tienda`.

**a) Backup en formato SQL (script plano)**

```bash
pg_dump -h localhost -p 5432 -U postgres -d tienda -f tienda_backup.sql
```

- Genera un archivo `tienda_backup.sql`.
- Se puede abrir con cualquier editor de texto.
- Se restaura con `psql`.

**b) Backup en formato personalizado (Custom Format: `-Fc`)**

```bash
pg_dump -h localhost -p 5432 -U postgres -d tienda -Fc -f tienda_backup.backup
```

- Genera un archivo binario (ej. `tienda_backup.backup`).
- Se restaura con `pg_restore` o desde **pgAdmin**.
- Permite restaurar tablas específicas, esquemas, etc.

**c) Backup de todas las bases de datos del servidor**

```bash
pg_dumpall -h localhost -p 5432 -U postgres -f cluster_completo.sql
```

- Incluye **todas** las bases del clúster.
- También se restaura con `psql`.

---

### 2. `pg_basebackup`: Backup físico del clúster

`pg_basebackup` genera un **respaldo físico completo del clúster** de PostgreSQL:

- Copia los **archivos internos** del motor (data directory).
- Puede incluir archivos WAL para recuperación punto en el tiempo.
- Suele terminar en directorios o archivos con extensión **`.backup`**.

Está recomendado para:

- **Disaster Recovery** (recuperación ante desastres).
- Montar servidores en **standby** o **réplicas**.
- Recuperar el **estado exacto** del servidor.

#### Ejemplo práctico de `pg_basebackup`

```bash
pg_basebackup \
  -h localhost \
  -p 5432 \
  -U replicacion \
  -D /var/backups/postgres/cluster_backup \
  -Fp -Xs -P -v
```

- `-U replicacion` → usuario con permisos de replicación.
- `-D` → directorio donde se almacenará el backup.
- `-Fp` → formato plano (directorio).
- `-Xs` → incluye archivos WAL necesarios.
- `-P -v` → muestra progreso y modo detallado.

---

### 3. Comparación entre `pg_dump` y `pg_basebackup`

| Característica         | `pg_dump` (lógico)                                | `pg_basebackup` (físico)                        |
|------------------------|---------------------------------------------------|-------------------------------------------------|
| Nivel de respaldo      | **Base de datos individual**                      | **Todo el clúster**                             |
| Contenido              | Estructura + datos (en formato SQL o binario)    | Archivos físicos del motor (data directory)     |
| Portabilidad           | **Muy alta** (entre versiones compatibles)       | Limitada (**misma versión y configuración**)    |
| Tamaño típico          | Más pequeño                                      | Más grande                                      |
| Uso recomendado        | Migraciones, respaldos lógicos, portabilidad     | Disaster Recovery, réplicas, standby            |
| Herramienta de restore | `psql` / `pg_restore` / pgAdmin                  | Copiar archivos + arrancar/reiniciar PostgreSQL |

---

## B. Tipos de Archivos de Respaldo

Para poder restaurar una base de datos, se debe conocer el **tipo de archivo de backup**:

| Tipo de archivo          | Origen                         | Ejemplo de extensión       | Herramienta de restauración principal     |
|--------------------------|--------------------------------|----------------------------|-------------------------------------------|
| Script SQL plano         | `pg_dump` / `pg_dumpall`      | `.sql`                     | `psql`                                    |
| Formato personalizado    | `pg_dump -Fc`                 | `.backup`, `.pgdump`, etc. | `pg_restore` o interfaz de **pgAdmin**    |
| Backup físico            | `pg_basebackup`               | Carpeta / archivo `.backup`| Reemplazo del data directory + reinicio   |

---

## C. Restauración de Bases de Datos

### 1. Restauración desde scripts SQL (`.sql`)

Los scripts generados por `pg_dump` o `pg_dumpall` se restauran con **`psql`**.

**Paso 1: Crear la base de datos de destino (si no existe)**

```sql
-- Dentro de psql conectado a postgres
CREATE DATABASE tienda_restaurada;
```

**Paso 2: Restaurar usando `psql`**

```bash
psql -h localhost -p 5432 -U postgres -d tienda_restaurada -f tienda_backup.sql
```

- Lee el archivo `tienda_backup.sql`.
- Ejecuta todas las sentencias SQL (CREATE TABLE, INSERT, etc.).

---

### 2. Restauración con `pg_restore` (formato personalizado)

Para archivos generados con `pg_dump -Fc`:

**a) Crear primero la base de datos vacía**

```bash
createdb -h localhost -p 5432 -U postgres tienda_restaurada
```

**b) Restaurar con `pg_restore`**

```bash
pg_restore -h localhost -p 5432 -U postgres \
  -d tienda_restaurada \
  tienda_backup.backup
```

**Opciones útiles de `pg_restore`:**

```bash
# Ver el contenido del backup (sin restaurar)
pg_restore -l tienda_backup.backup

# Restaurar solo una tabla específica
pg_restore -h localhost -U postgres \
  -d tienda_restaurada \
  -t productos \
  tienda_backup.backup
```

---

### 3. Restauración de backups físicos (`pg_basebackup`)

Para un backup tomado con `pg_basebackup`, el proceso general es:

1. **Detener el servicio de PostgreSQL.**
2. **Reemplazar el directorio de datos** actual por el del backup.
3. Verificar permisos del directorio (usuario `postgres` normalmente).
4. **Iniciar nuevamente** el servicio de PostgreSQL.

Ejemplo simplificado en Linux:

```bash
# 1. Detener PostgreSQL
sudo systemctl stop postgresql

# 2. Limpiar el directorio de datos actual (¡cuidado!)
sudo rm -rf /var/lib/postgresql/15/main/*

# 3. Copiar el contenido del backup físico
sudo cp -R /var/backups/postgres/cluster_backup/* /var/lib/postgresql/15/main/

# 4. Ajustar permisos
sudo chown -R postgres:postgres /var/lib/postgresql/15/main/

# 5. Iniciar PostgreSQL
sudo systemctl start postgresql
```

> En entornos reales, este procedimiento debe seguir las políticas de la organización y buenas prácticas de seguridad.

---

## D. Ejecución desde Línea de Comandos y pgAdmin

### 1. Uso de la línea de comandos (CMD / Terminal)

Para usar `pg_dump`, `pg_restore`, `psql` o `pg_basebackup` desde la terminal, es necesario que el sistema reconozca el directorio `bin` de PostgreSQL.

#### Ejemplo en Windows (CMD)

```bat
cd "C:\Program Files\PostgreSQL\15\bin"
pg_dump --version
```

O agregando PostgreSQL al **PATH** temporalmente:

```bat
set PATH=%PATH%;"C:\Program Files\PostgreSQL\15\bin"
pg_dump --version
```

A partir de ahí se pueden ejecutar:

```bat
pg_dump -h localhost -U postgres -d tienda -f tienda_backup.sql
pg_restore -h localhost -U postgres -d tienda_restaurada tienda_backup.backup
```

---

### 2. Uso de pgAdmin (interfaz gráfica)

Desde **pgAdmin** se pueden realizar y restaurar backups sin escribir comandos:

- **Backup**:
  - Clic derecho sobre la base de datos → **Backup…**
  - Elegir formato: `Plain` (SQL) o `Custom` (`.backup`).
- **Restore**:
  - Clic derecho sobre la base de datos de destino → **Restore…**
  - Seleccionar el archivo `.backup` o `.sql`.
  - Configurar opciones y ejecutar.

---

## E. Analogía para Entender los Métodos

> **`pg_dump`** es como escribir una **receta detallada** de tu plato favorito (la base de datos):  
> puedes llevarla a otra cocina (servidor) y volver a prepararlo paso a paso.  
>  
> **`pg_basebackup`** es como hacer una **copia exacta de toda la cocina y el refrigerador** (el clúster completo):  
> es más pesado y menos flexible, pero te permite volver exactamente al estado que tenías antes de un desastre.

---