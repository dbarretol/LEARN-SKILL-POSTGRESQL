## VII. Manejo de Imágenes en Formato Binario

En esta sección se muestra cómo **almacenar imágenes directamente en PostgreSQL**, usando el tipo de dato **`bytea`** para guardar el contenido binario.

PostgreSQL ofrece un soporte robusto para datos binarios, lo que lo hace adecuado para escenarios donde se requiere:

- Mantener las imágenes **dentro de la base de datos** (y no solo en el sistema de archivos).
- Garantizar **integridad transaccional** entre datos y archivos.
- Acceso unificado a la información desde aplicaciones (API, servicios, etc.).

> Nota: Aunque es totalmente posible guardar imágenes en la base de datos, en sistemas muy grandes suele evaluarse también la alternativa de almacenarlas en disco/objetos (S3, etc.) y guardar solo la ruta en la BD.

---

## A. Creación de una tabla para almacenar imágenes (`bytea`)

Se creó una tabla llamada `imagenes_binario`, diseñada para almacenar tanto metadatos como el contenido binario de la imagen.

### 1. Definición de la tabla

```sql
CREATE TABLE imagenes_binario (
    id             SERIAL PRIMARY KEY,
    nombre_archivo VARCHAR(255) NOT NULL,
    tipo_imagen    VARCHAR(50),
    datos          BYTEA NOT NULL,
    fecha_subida   TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    tamano         BIGINT GENERATED ALWAYS AS (octet_length(datos)) STORED
);
```

### 2. Descripción de los campos

| Campo           | Tipo              | Descripción                                                                 |
|-----------------|-------------------|-----------------------------------------------------------------------------|
| `id`            | `SERIAL`          | Identificador único, clave primaria.                                       |
| `nombre_archivo`| `VARCHAR(255)`    | Nombre original del archivo (ej. `foto_perfil.png`).                       |
| `tipo_imagen`   | `VARCHAR(50)`     | Tipo MIME o formato (`image/jpeg`, `image/png`, `JPG`, etc.).              |
| `datos`         | `BYTEA`           | Contenido binario de la imagen.                                            |
| `fecha_subida`  | `TIMESTAMP`       | Fecha y hora en que se almacenó la imagen.                                 |
| `tamano`        | `BIGINT`          | Tamaño de la imagen en bytes (calculado automáticamente).                  |

La columna `tamano` usa `octet_length(datos)` para calcular el tamaño del campo binario automáticamente:

```sql
octet_length(datos) -- devuelve el tamaño en bytes de la columna bytea
```

---

## B. Inserción de imágenes usando funciones de PostgreSQL

Para insertar una imagen en formato binario, se puede utilizar la función **`pg_read_binary_file()`**, que lee un archivo directamente desde el sistema de archivos del servidor PostgreSQL.

> Importante:
> - `pg_read_binary_file()` solo puede leer archivos a los que el servidor tenga acceso.
> - Normalmente requiere permisos de superusuario.
> - La ruta del archivo es **vista desde el servidor**, no desde el cliente.

### 1. Ejemplo de inserción desde el servidor de BD

Supongamos que en el servidor PostgreSQL existe la imagen:

- Ruta: `/var/data/imagenes/skill.jpg`
- Tipo: `image/jpeg`

```sql
INSERT INTO imagenes_binario (nombre_archivo, tipo_imagen, datos)
VALUES (
    'skill.jpg',
    'image/jpeg',
    pg_read_binary_file('/var/data/imagenes/skill.jpg')::bytea
);
```

Tras ejecutar este `INSERT`:

- La imagen queda almacenada en el campo `datos`.
- La columna `fecha_subida` toma automáticamente `CURRENT_TIMESTAMP`.
- La columna `tamano` se calcula automáticamente.

### 2. Verificación de los datos insertados

Para comprobar que la imagen se almacenó correctamente:

```sql
SELECT
    id,
    nombre_archivo,
    tipo_imagen,
    tamano,
    fecha_subida
FROM imagenes_binario;
```

Y para ver el tamaño calculado mediante la función:

```sql
SELECT
    id,
    nombre_archivo,
    octet_length(datos) AS bytes_real,
    tamano              AS bytes_generado
FROM imagenes_binario;
```

Los valores de `bytes_real` y `bytes_generado` deberían coincidir.

---

## C. Uso de las imágenes desde aplicaciones

En la práctica, es muy común que las imágenes se inserten y se lean desde una aplicación (por ejemplo, en **Python**, **Java**, **C#**, etc.), usando parámetros binarios en lugar de `pg_read_binary_file()`.

### 1. Ejemplo en Python (insertar imagen)

```python
import psycopg2

conexion = psycopg2.connect(
    host="localhost",
    port=5432,
    dbname="tienda",
    user="postgres",
    password="123456"
)

with conexion:
    with conexion.cursor() as cur:
        with open("skill.jpg", "rb") as f:
            datos_binarios = f.read()

        cur.execute("""
            INSERT INTO imagenes_binario (nombre_archivo, tipo_imagen, datos)
            VALUES (%s, %s, %s)
            RETURNING id, tamano;
        """, ("skill.jpg", "image/jpeg", psycopg2.Binary(datos_binarios)))

        id_generado, tamano = cur.fetchone()
        print(f"Imagen guardada con id={id_generado}, tamaño={tamano} bytes")

conexion.close()
```

### 2. Ejemplo en Python (leer imagen y guardarla en disco)

```python
import psycopg2

conexion = psycopg2.connect(
    host="localhost",
    port=5432,
    dbname="tienda",
    user="postgres",
    password="123456"
)

with conexion:
    with conexion.cursor() as cur:
        cur.execute("""
            SELECT nombre_archivo, datos
            FROM imagenes_binario
            WHERE id = %s;
        """, (1,))  # Cambia 1 por el id deseado

        fila = cur.fetchone()
        if fila:
            nombre_archivo, datos_binarios = fila
            with open("copia_" + nombre_archivo, "wb") as f:
                f.write(datos_binarios)
            print(f"Imagen extraída como copia_{nombre_archivo}")
        else:
            print("No se encontró la imagen solicitada.")

conexion.close()
```

---

## D. Consulta y filtrado de imágenes

Puedes realizar consultas sobre la tabla `imagenes_binario` como sobre cualquier otra:

### 1. Listar todas las imágenes

```sql
SELECT
    id,
    nombre_archivo,
    tipo_imagen,
    tamano,
    fecha_subida
FROM imagenes_binario
ORDER BY fecha_subida DESC;
```

### 2. Filtrar por tipo de imagen

```sql
SELECT
    id,
    nombre_archivo,
    tamano
FROM imagenes_binario
WHERE tipo_imagen = 'image/jpeg';
```

### 3. Obtener solo metadatos (sin traer el campo binario en el cliente)

Es buena práctica evitar traer el campo `datos` si no es necesario, para no consumir ancho de banda:

```sql
SELECT
    id,
    nombre_archivo,
    tipo_imagen,
    tamano
FROM imagenes_binario;
```

---

## E. Resumen

- PostgreSQL permite almacenar imágenes usando el tipo **`BYTEA`**.
- La tabla `imagenes_binario` combina **metadatos** (nombre, tipo, fecha) con el **contenido binario**.
- La función **`pg_read_binary_file()`** permite cargar imágenes desde el sistema de archivos del servidor.
- Las aplicaciones (Python, Java, etc.) pueden insertar y leer imágenes usando parámetros binarios.
- Campos como `tamano` pueden definirse como **columnas generadas** para facilitar auditoría y validación.

Con este enfoque, se obtiene un manejo consistente y transaccional de archivos binarios directamente desde PostgreSQL.