## X. Realización y Restauración de Backups (Práctica Detallada)

En esta sección se muestra cómo realizar **copias de seguridad** y **restauraciones** de bases de datos PostgreSQL usando:

- La interfaz gráfica **pgAdmin**.
- La **línea de comandos** (`pg_dump`, `pg_restore`, `psql`).

Los ejemplos se enfocan en la base de datos de ejemplo **`tienda`**.

---

## A. Backup mediante interfaz gráfica (pgAdmin)

La interfaz de **pgAdmin** permite generar backups de forma sencilla, sin escribir comandos.

### 1. Pasos para hacer backup en pgAdmin

1. **Seleccionar la base de datos**  
   - En el árbol de navegación, clic derecho sobre la base de datos (por ejemplo, `tienda`).
   - Seleccionar **Backup…**.

2. **Elegir ubicación y nombre del archivo**
   - En el campo **Filename**, especificar la carpeta y el nombre del archivo:
     - Ejemplo:  
       `C:\backups\tienda_2025-07-17_0215.backup`

3. **Seleccionar formato**
   - En **Format** se pueden elegir, entre otros:
     - `Custom` → formato binario personalizado (`.backup`), recomendado para usar con `pg_restore`.
     - `Plain` → script SQL plano (`.sql`), útil para leer/editar o restaurar con `psql`.
   - Para este ejemplo, se suele usar **`Custom`**.

4. **Opciones de datos (Data options)**  
   - Se pueden indicar opciones como:
     - Incluir solo **estructura** (schema).
     - Incluir solo **datos**.
     - Incluir **estructura + datos** (lo más común).
   - En una práctica básica se suele dejar la configuración por defecto (estructura + datos).

5. **Selección de objetos**
   - En la pestaña **Objects**:
     - Se pueden seleccionar **todas las tablas**, esquemas, funciones, etc.
     - O elegir solo algunos objetos específicos.

6. **Ejecutar el backup**
   - Hacer clic en **Backup**.
   - pgAdmin generará el archivo en la ruta especificada.

> Este archivo (`.backup` o `.sql`) se puede copiar y utilizar en otro servidor para restaurar la base de datos.

---

## B. Backup y restauración mediante línea de comandos

Para tener mayor control (y automatizar procesos), es muy común usar los comandos:

- `pg_dump` → generar backups.
- `pg_restore` → restaurar backups en formato personalizado.
- `psql` → restaurar backups en formato SQL plano.

### 1. Configuración del entorno: agregar `bin` de PostgreSQL al PATH

Para poder ejecutar `pg_dump`, `pg_restore`, `psql`, etc. desde cualquier carpeta en la terminal, se debe agregar el directorio `bin` de PostgreSQL al **PATH**.

#### Ejemplo en Windows (CMD)

Supongamos que PostgreSQL está instalado en:

`C:\Program Files\PostgreSQL\15\bin`

En una sesión de CMD:

```bat
set PATH=%PATH%;"C:\Program Files\PostgreSQL\15\bin"
pg_dump --version
```

Si el comando anterior muestra la versión de `pg_dump`, la ruta está bien configurada.

> Para que el cambio sea permanente, se recomienda agregar la ruta al PATH desde **Propiedades del sistema → Variables de entorno**.

---

### 2. Backup con `pg_dump` (formato `.backup`)

#### 2.1. Backup en formato personalizado (`Custom`)

Ejemplo: crear un backup de la base de datos `tienda` en un archivo `tienda_DBA.backup`.

```bat
pg_dump -U postgres -h localhost -p 5432 -d tienda -Fc -f "C:\backups\tienda_DBA.backup"
```

Parámetros principales:

- `-U postgres` → usuario de conexión.
- `-h localhost` → servidor.
- `-p 5432` → puerto.
- `-d tienda` → base de datos a respaldar.
- `-Fc` → formato `Custom`.
- `-f "C:\backups\tienda_DBA.backup"` → archivo de salida.

Al ejecutar, se solicitará la contraseña del usuario `postgres`.  

Este formato es ideal para restaurar luego con `pg_restore`.

#### 2.2. Backup en formato SQL plano

```bat
pg_dump -U postgres -h localhost -p 5432 -d tienda -f "C:\backups\tienda_DBA.sql"
```

- No se especifica `-Fc`, por lo que el formato por defecto es **SQL plano**.
- Este archivo se puede restaurar con `psql`.

---

### 3. Restauración de backups

La restauración depende del **tipo de archivo** que se haya generado:

- **Formato SQL (`.sql`)** → se restaura con `psql`.
- **Formato personalizado (`.backup`)** → se restaura con `pg_restore`.

Antes de restaurar, normalmente se crea una **base de datos vacía** de destino.

#### 3.1. Crear una nueva base de datos

Puedes crearla de varias formas:

**a) Desde línea de comandos con `createdb`:**

```bat
createdb -U postgres -h localhost -p 5432 tienda_online_db
```

**b) Desde `psql`:**

```sql
CREATE DATABASE tienda_online_db;
```

---

### 4. Restaurar con `pg_restore` (formato `.backup`)

Ejemplo: restaurar el archivo `tienda_DBA.backup` en la base de datos `tienda_online_db`.

```bat
pg_restore -U postgres -h localhost -p 5432 -d tienda_online_db -v "C:\backups\tienda_DBA.backup"
```

Parámetros:

- `-U postgres` → usuario.
- `-h localhost` → servidor.
- `-p 5432` → puerto.
- `-d tienda_online_db` → base de datos de destino.
- `-v` → modo detallado (verbose), muestra más información.
- `"C:\backups\tienda_DBA.backup"` → archivo a restaurar.

> Si el archivo es muy grande, el proceso puede tardar algunos minutos.

---

### 5. Restaurar con `psql` (formato `.sql`)

Si el backup se generó como **script SQL plano**:

```bat
psql -U postgres -h localhost -p 5432 -d tienda_online_db -f "C:\backups\tienda_DBA.sql"
```

- `psql` leerá el archivo `.sql` y ejecutará las sentencias `CREATE TABLE`, `INSERT`, etc.

---

### 6. Verificación de la restauración

Para confirmar que la restauración fue exitosa:

1. Abrir **pgAdmin**.
2. Refrescar la lista de bases de datos.
3. Verificar que aparece **`tienda_online_db`**.
4. Expandir:
   - **Schemas → public → Tables**
   - Confirmar que las tablas esperadas (por ejemplo, `usuarios`, `productos`, etc.) están presentes.
5. Probar una consulta:

```sql
SELECT COUNT(*) FROM usuarios;
SELECT * FROM productos LIMIT 10;
```

Si las tablas y los datos coinciden con la base original, la restauración se ha realizado correctamente.

---

## Resumen

- Con **pgAdmin** puedes realizar backups de forma gráfica, eligiendo entre formatos `Custom` y `Plain`.
- Con la **línea de comandos**:
  - `pg_dump` genera el backup (en `.backup` o `.sql`).
  - `pg_restore` restaura archivos `.backup` (formato personalizado).
  - `psql` restaura archivos `.sql` (scripts planos).
- Siempre es buena práctica:
  - Nombrar los archivos con **fecha/hora**.
  - Probar la restauración en una base de datos **de prueba**.
  - Verificar tablas y datos tras restaurar.

Con estas herramientas puedes implementar rutinas de backup y recuperación **confiables y repetibles** para tus bases de datos PostgreSQL.