## Separata: Creación de Bases de Datos y Esquemas en PostgreSQL

Esta separata explica cómo **crear y eliminar bases de datos**, así como cómo organizar su estructura interna mediante **esquemas**, siguiendo buenas prácticas de administración.

---

## A. Creación y Eliminación de Bases de Datos

En el ejemplo de clase se utilizaron nombres como `tienda_dba` y `tienda_db`.  
Recomendaciones de estilo:

- Evitar espacios en los nombres.
- Usar minúsculas y **guion bajo**: `tienda_db`, `mi_app`, `erp_finanzas`.

---

### 1. Eliminación de bases de datos (`DROP DATABASE`)

Para eliminar una base de datos:

```sql
DROP DATABASE tienda_db;
```

Sin embargo, este comando puede fallar si:

- Existen **conexiones activas** a esa base de datos.
- Alguna sesión (incluso la tuya) está conectada a `tienda_db`.

En esos casos, PostgreSQL devolverá un error similar a:

```text
ERROR:  database "tienda_db" is being accessed by other users
```

#### a) Procedimiento recomendado

1. Conectarse a **otra base de datos distinta**, por ejemplo `postgres`.
2. Terminar las conexiones activas hacia `tienda_db`.
3. Ejecutar `DROP DATABASE`.

Ejemplo completo:

```sql
-- 1. Asegúrate de estar conectado a 'postgres' (o a otra BD distinta a tienda_db)

-- 2. Terminar conexiones activas a tienda_db (excepto la sesión actual)
SELECT pg_terminate_backend(pid)
FROM pg_stat_activity
WHERE datname = 'tienda_db'
  AND pid <> pg_backend_pid();

-- 3. Eliminar la base de datos
DROP DATABASE tienda_db;
```

> Advertencia: `pg_terminate_backend` cerrará sesiones de otros usuarios; úsalo con cuidado en entornos compartidos.

---

### 2. Creación correcta de bases de datos (`CREATE DATABASE`)

Creación básica:

```sql
CREATE DATABASE tienda_db;
```

Creación con parámetros recomendados:

```sql
CREATE DATABASE tienda_db
WITH 
    OWNER            = postgres
    ENCODING         = 'UTF8'
    CONNECTION LIMIT = -1
    TEMPLATE         = template0;
```

#### Parámetros clave

| Parámetro          | Descripción                                                                 |
|--------------------|-----------------------------------------------------------------------------|
| `OWNER`            | Usuario propietario de la base de datos (ej. `postgres` o un rol de app).  |
| `ENCODING`         | Codificación de caracteres. `UTF8` es la recomendada en la mayoría de casos. |
| `CONNECTION LIMIT` | Número máximo de conexiones simultáneas. `-1` = sin límite (por defecto).  |
| `TEMPLATE`         | Plantilla usada para crear la BD (`template0` o `template1`).              |

- `template0`: plantilla **mínima**, recomendada para bases nuevas limpias.
- `template1`: plantilla estándar; incluye configuraciones y extensiones que se hayan agregado allí.

---

## B. Definición y Uso de Esquemas

Al crear una base de datos (por ejemplo `tienda_db`), PostgreSQL crea por defecto el esquema **`public`**.

Aunque es totalmente funcional, una buena práctica en proyectos profesionales es:

- **No usar `public`** para las tablas de negocio.
- Crear uno o varios **esquemas propios** (por ejemplo, `tienda`, `seguridad`, `reportes`).

---

### 1. Conexión a la base de datos

Antes de crear esquemas, debes conectarte a la base de datos donde quieres trabajar.

En `psql`:

```bash
psql -U postgres -h localhost -d tienda_db
```

En pgAdmin:

- Seleccionar el servidor.
- Hacer clic en la base de datos `tienda_db`.

---

### 2. Creación de un esquema propio

Ejemplo: crear un esquema llamado `tienda`:

```sql
CREATE SCHEMA IF NOT EXISTS tienda;
```

A partir de ese momento, puedes crear tablas especificando el esquema:

```sql
CREATE TABLE tienda.productos (
    id_producto  SERIAL PRIMARY KEY,
    nombre       VARCHAR(100) NOT NULL,
    precio       NUMERIC(10,2) NOT NULL
);
```

Y consultar:

```sql
SELECT * FROM tienda.productos;
```

---

### 3. Definir el esquema por defecto (`search_path`)

Si no configuras nada, PostgreSQL busca primero en el esquema `public`.  
Para no tener que escribir siempre `tienda.` como prefijo, puedes ajustar el **`search_path`**.

#### a) Cambiar el esquema por defecto en la sesión actual

```sql
SET search_path TO tienda;
```

Ahora puedes escribir:

```sql
CREATE TABLE clientes (
    id_cliente  SERIAL PRIMARY KEY,
    nombre      VARCHAR(100) NOT NULL
);

SELECT * FROM clientes;
```

Y PostgreSQL interpretará `tienda.clientes`.

---

#### b) Configurar `search_path` a nivel de base de datos o rol

Para que el esquema por defecto se aplique siempre, puedes configurarlo de forma persistente.

**A nivel de base de datos:**

```sql
ALTER DATABASE tienda_db
SET search_path TO tienda;
```

**A nivel de rol (usuario):**

```sql
ALTER ROLE usuario_tienda
SET search_path TO tienda;
```

La próxima vez que el usuario o la base de datos se inicie sesión, el `search_path` ya estará configurado.

---

## Resumen

- Usa `CREATE DATABASE` con parámetros explícitos (`OWNER`, `ENCODING`, `TEMPLATE`) para mayor control.
- Antes de hacer `DROP DATABASE`, finaliza conexiones activas usando `pg_stat_activity` y `pg_terminate_backend`.
- Organiza tu modelo dentro de **esquemas propios** en lugar de usar siempre `public`.
- Configura el `search_path` para trabajar de forma más cómoda, sin tener que prefijar el esquema en cada consulta.

Con estas prácticas, tu entorno PostgreSQL será **más ordenado, seguro y fácil de mantener** desde el inicio del proyecto.