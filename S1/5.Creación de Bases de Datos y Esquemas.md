## Separata: Creación de Bases de Datos y Esquemas en PostgreSQL

Esta sección aborda la gestión de bases de datos y su estructuración interna mediante esquemas, incluyendo buenas prácticas para su creación y eliminación.

---

### A. Creación y Eliminación de Bases de Datos

En el ejemplo se creó una base de datos llamada inicialmente `tienda_dba` y luego `tienda_db`.  
(Es recomendable **evitar espacios** en los nombres y usar guion bajo).

#### 1. Eliminación de Bases de Datos (`DROP DATABASE`)

Para eliminar una base de datos con:

```sql
DROP DATABASE tienda_db;
```

puede aparecer un error si la base de datos tiene **conexiones activas** (por ejemplo, si está seleccionada o en uso por alguna sesión).

La forma correcta y profesional de proceder es:

1. **Finalizar las conexiones activas** usando la vista del sistema `pg_stat_activity`.
2. Ejecutar luego el `DROP DATABASE`.

Ejemplo para terminar conexiones (excepto la actual) y luego eliminar:

```sql
-- Conectado a otra base de datos distinta a tienda_db
SELECT pg_terminate_backend(pid)
FROM pg_stat_activity
WHERE datname = 'tienda_db'
  AND pid <> pg_backend_pid();

DROP DATABASE tienda_db;
```

#### 2. Creación Correcta de Bases de Datos (`CREATE DATABASE`)

Para crear una base de datos con parámetros recomendados se usa:

```sql
CREATE DATABASE tienda_db
WITH 
    OWNER = postgres
    ENCODING = 'UTF8'
    CONNECTION LIMIT = -1
    TEMPLATE = template0;
```

Parámetros principales:

1. **OWNER:** Usuario propietario de la base de datos (por ejemplo, `postgres`).
2. **ENCODING:** Codificación de caracteres, habitualmente `UTF8`.
3. **CONNECTION LIMIT:** Máximo de conexiones permitidas.  
   - `-1` = sin límite (valor por defecto).
4. **TEMPLATE:**  
   - `template0`: plantilla mínima recomendada para nuevas bases de datos de usuario.  
   - `template1`: plantilla estándar del sistema (se usa para crear otras plantillas o bases con configuraciones del sistema).

---

### B. Definición de Esquemas

Después de crear una base de datos (por ejemplo, `tienda_db`), esta contiene por defecto el esquema `public`.  
Es una buena práctica **no usar el esquema `public`** para las tablas de la aplicación y crear un esquema propio.

#### 1. Conexión a la Base de Datos

Antes de crear un esquema, es necesario conectarse a la base de datos recién creada:

- En **pgAdmin**: seleccionar la base de datos `tienda_db` usando un rol con permisos suficientes (por ejemplo, el rol `postgres`).

#### 2. Creación de un Esquema Propio

Ejemplo de creación de un esquema llamado `tienda`:

```sql
CREATE SCHEMA IF NOT EXISTS tienda;
```

#### 3. Definir el Esquema por Defecto (`search_path`)

Si no se define un esquema por defecto, al crear o consultar tablas se debe prefijar el nombre del esquema:

```sql
SELECT * FROM tienda.nombre_tabla;
```

Para evitar escribir el prefijo constantemente, se configura el esquema propio en la ruta de búsqueda (`search_path`):

```sql
SET search_path TO tienda;
```

A partir de ese momento, en la sesión actual se podrán crear y consultar tablas sin prefijar el esquema:

```sql
CREATE TABLE nombre_tabla (...);
SELECT * FROM nombre_tabla;
```

(De forma más permanente, el `search_path` puede configurarse a nivel de **rol** o **base de datos** con `ALTER ROLE` o `ALTER DATABASE` si se requiere.)