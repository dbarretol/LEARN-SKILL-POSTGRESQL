## Separata: Creación de Tablas con Características Avanzadas en PostgreSQL

Esta sección se centra en técnicas avanzadas de PostgreSQL para la definición de tablas: generación de identificadores únicos (IDs), validaciones (*constraints*) y uso de tipos personalizados como `ENUM`.

---

### A. Extensiones y Generación de IDs Únicos

Para tablas que requieren identificadores robustos (por ejemplo, usuarios), es habitual usar **UUIDs** en lugar de enteros autoincrementales.

#### 1. UUID (Identificador Único Universal)

En lugar de usar `SERIAL` o `BIGSERIAL`, puede emplearse el tipo `UUID`.

- **Propósito:** Generar identificadores únicos.
- **Características:**
  - Tamaño: **128 bits (16 bytes)**.
  - Unicidad: alta probabilidad de ser único a nivel global.
  - Formato típico: cadena con guiones, por ejemplo:  
    `550e8400-e29b-41d4-a716-446655440000`.

Para generar UUID versión 4 (aleatorio), se usa la extensión `uuid-ossp`:

```sql
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
```

Luego, en la tabla:

```sql
usuario_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY
```

#### 2. Función para Generar Cadenas Aleatorias

Se puede crear una función `random_string` en **PL/pgSQL** para generar textos aleatorios (por ejemplo, contraseñas de prueba o tokens):

- **Uso típico:** generación de valores pseudoaleatorios para pruebas o datos temporales.
- **Mecanismo:** bucle `FOR` que va concatenando caracteres elegidos al azar de un conjunto predefinido (mayúsculas, minúsculas y dígitos).

Ejemplo simplificado:

```sql
CREATE OR REPLACE FUNCTION random_string(p_length INT)
RETURNS TEXT AS
$$
DECLARE
    chars   TEXT := 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    result  TEXT := '';
    i       INT;
BEGIN
    FOR i IN 1..p_length LOOP
        result := result || substr(chars, (random() * length(chars) + 1)::INT, 1);
    END LOOP;

    RETURN result;
END;
$$
LANGUAGE plpgsql;
```

---

### B. Definición de la Tabla de Usuarios

La tabla `usuario` puede definirse utilizando `UUID` como clave primaria y diversas restricciones para garantizar la integridad de los datos.

#### 1. Clave Primaria con UUID

- Columna `usuario_id` de tipo `UUID`.
- Definida como `PRIMARY KEY`.
- Valor por defecto mediante `uuid_generate_v4()`:

```sql
CREATE TABLE usuario (
    usuario_id      UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    nombres         VARCHAR(100) NOT NULL,
    apellidos       VARCHAR(100) NOT NULL,
    email           VARCHAR(255) NOT NULL UNIQUE,
    password        TEXT NOT NULL,
    estado          VARCHAR(20) NOT NULL,
    fecha_creacion  TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    ultimo_login    TIMESTAMPTZ,
    es_admin        BOOLEAN NOT NULL DEFAULT FALSE
);
```

#### 2. Validación de Datos (Constraints)

Se pueden agregar más restricciones para reforzar la calidad de los datos:

- `NOT NULL`: obliga a que ciertos campos estén siempre informados (`nombres`, `apellidos`, `email`, `password`, etc.).
- `UNIQUE`: evita duplicados en columnas como `email`.
- `CHECK`: valida reglas específicas, como:

  - Formato del correo electrónico.
  - Conjunto permitido de valores para `estado`.

Ejemplo (formato de email y valores permitidos para `estado`):

```sql
ALTER TABLE usuario
ADD CONSTRAINT chk_usuario_email
    CHECK (email ~* '^[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}$'),

ADD CONSTRAINT chk_usuario_estado
    CHECK (estado IN ('activo', 'inactivo', 'suspendido'));
```

#### 3. Tipos de Fecha, Hora y Booleanos

- `TIMESTAMPTZ` (`TIMESTAMP WITH TIME ZONE`) para:
  - `fecha_creacion` (con `DEFAULT CURRENT_TIMESTAMP`).
  - `ultimo_login`.
- `BOOLEAN` para campos lógicos como `es_admin` (por defecto `FALSE` o `TRUE` según el diseño).

---

### C. Tipos Personalizados (ENUM)

En lugar de un `VARCHAR` con `CHECK`, se puede definir un tipo `ENUM` para representar estados de usuario de forma más estricta y legible.

#### 1. Creación del Tipo ENUM

Se crea un tipo llamado `estado_de_usuario`:

```sql
CREATE TYPE estado_de_usuario AS ENUM ('activo', 'inactivo', 'suspendido');
```

Este tipo solo acepta esos valores.

#### 2. Uso del ENUM en la Tabla

Una vez creado el tipo, la columna `estado` pasa a ser de tipo `estado_de_usuario`:

```sql
CREATE TABLE usuario (
    usuario_id      UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    nombres         VARCHAR(100) NOT NULL,
    apellidos       VARCHAR(100) NOT NULL,
    email           VARCHAR(255) NOT NULL UNIQUE,
    password        TEXT NOT NULL,
    estado          estado_de_usuario NOT NULL DEFAULT 'activo',
    fecha_creacion  TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    ultimo_login    TIMESTAMPTZ,
    es_admin        BOOLEAN NOT NULL DEFAULT FALSE
);
```

El uso de `ENUM` hace que el conjunto de valores válidos esté fuertemente tipado a nivel de base de datos, lo que mejora la consistencia y la semántica, de forma similar a los tipos definidos en otros SGBD como Oracle.