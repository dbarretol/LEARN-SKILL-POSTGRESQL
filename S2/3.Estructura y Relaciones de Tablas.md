# III. Estructura y Relaciones de Tablas

## 1. Creación de Tablas y Definición de Claves

La creación de tablas en una base de datos relacional se realiza con la instrucción `CREATE TABLE`.  
Durante el diseño, es esencial definir:

- **Claves primarias** → identifican de forma única cada fila.
- **Claves foráneas** → establecen relaciones y mantienen la integridad referencial.

### 1.1 Ejemplo básico de creación de tabla

```sql
CREATE TABLE cliente (
    id_cliente  SERIAL PRIMARY KEY,        -- Clave primaria
    nombre      VARCHAR(100) NOT NULL,
    email       VARCHAR(150) UNIQUE NOT NULL,
    creado_en   TIMESTAMPTZ DEFAULT NOW()
);
```

Puntos clave:

- `PRIMARY KEY` → define la clave primaria.
- `UNIQUE` → garantiza que no haya valores repetidos.
- `NOT NULL` → obliga a que la columna tenga siempre un valor.

---

### 1.2 Clave Primaria (*Primary Key*)

La **clave primaria**:

- Identifica de forma **única** cada registro.
- **No permite valores nulos**.
- Puede ser:
  - **Simple**: una sola columna.
  - **Compuesta**: varias columnas en conjunto.

| Tipo de PK   | Descripción                              | Ejemplo                               |
|-------------|-------------------------------------------|---------------------------------------|
| Simple      | Una sola columna.                        | `id_cliente`                          |
| Compuesta   | Dos o más columnas combinadas.           | `(id_pedido, numero_linea)`           |

#### Ejemplo: clave primaria simple

```sql
CREATE TABLE producto (
    id_producto  SERIAL PRIMARY KEY,
    nombre       VARCHAR(100) NOT NULL,
    precio       NUMERIC(10,2) NOT NULL
);
```

#### Ejemplo: clave primaria compuesta

```sql
CREATE TABLE pedido_detalle (
    id_pedido       INT,
    numero_linea    INT,
    id_producto     INT NOT NULL,
    cantidad        INT NOT NULL,
    precio_unitario NUMERIC(10,2) NOT NULL,
    PRIMARY KEY (id_pedido, numero_linea)
);
```

---

### 1.3 Clave Foránea (*Foreign Key*)

La **clave foránea**:

- Es una o varias columnas que **referencian** la clave primaria (u otra clave única) de otra tabla.
- Mantiene la **integridad referencial**:
  - Solo permite valores que existan en la tabla referenciada.
- Puede permitir `NULL` si la relación es **opcional**.

#### Ejemplo: clave foránea y relación obligatoria (NOT NULL)

```sql
CREATE TABLE pedido (
    id_pedido   SERIAL PRIMARY KEY,
    id_cliente  INT NOT NULL,
    fecha       TIMESTAMPTZ DEFAULT NOW(),
    total       NUMERIC(10,2) NOT NULL,
    CONSTRAINT fk_pedido_cliente
        FOREIGN KEY (id_cliente)
        REFERENCES cliente (id_cliente)
        ON UPDATE CASCADE
        ON DELETE RESTRICT
);
```

- `ON UPDATE CASCADE` → si cambia `id_cliente` en `cliente`, se actualiza también en `pedido`.
- `ON DELETE RESTRICT` → impide eliminar un cliente si tiene pedidos asociados.

#### Ejemplo: clave foránea opcional (permite NULL)

```sql
CREATE TABLE factura (
    id_factura  SERIAL PRIMARY KEY,
    id_pedido   INT,      -- Puede ser NULL si no todos los pedidos generan factura
    fecha       DATE NOT NULL,
    total       NUMERIC(10,2) NOT NULL,
    FOREIGN KEY (id_pedido) REFERENCES pedido (id_pedido)
);
```

---

## 2. Relaciones entre Tablas

Las claves primarias y foráneas permiten modelar distintos tipos de relaciones:

- **Uno a uno (1:1)**
- **Uno a muchos (1:N)**
- **Muchos a muchos (N:M)**

| Tipo de relación | Descripción breve                                         |
|------------------|-----------------------------------------------------------|
| 1:1              | Un registro A ↔ un registro B                            |
| 1:N              | Un registro A ↔ muchos registros B                       |
| N:M              | Muchos registros A ↔ muchos registros B (tabla puente)   |

---

### 2.1 Relación Uno a Uno (1:1)

En una relación **1:1**:

- Cada registro en la tabla A se asocia con **a lo sumo un** registro en la tabla B.
- Se usa para:
  - Separar información opcional.
  - Dividir datos sensibles o poco usados.

#### Ejemplo: persona y detalles adicionales

```sql
CREATE TABLE persona (
    id_persona  SERIAL PRIMARY KEY,
    nombre      VARCHAR(100) NOT NULL
);

CREATE TABLE persona_detalle (
    id_persona        INT PRIMARY KEY,  -- También es PK → garantiza 1:1
    direccion         VARCHAR(200),
    telefono          VARCHAR(50),
    fecha_nacimiento  DATE,
    FOREIGN KEY (id_persona) REFERENCES persona (id_persona)
);
```

- Cada `persona` tiene **como máximo un** `persona_detalle`.
- `persona_detalle.id_persona` es a la vez:
  - **Clave primaria**.
  - **Clave foránea** hacia `persona`.

Consulta de ejemplo:

```sql
SELECT
    p.id_persona,
    p.nombre,
    d.direccion,
    d.telefono
FROM persona p
LEFT JOIN persona_detalle d
    ON p.id_persona = d.id_persona;
```

---

### 2.2 Relación Uno a Muchos (1:N)

En una relación **1:N**:

- Un registro de la tabla **padre** se relaciona con **varios** registros en la tabla **hija**.
- La clave foránea se define en la **tabla hija**.

#### Ejemplo: cliente y pedidos

```sql
CREATE TABLE cliente (
    id_cliente  SERIAL PRIMARY KEY,
    nombre      VARCHAR(100) NOT NULL
);

CREATE TABLE pedido (
    id_pedido   SERIAL PRIMARY KEY,
    id_cliente  INT NOT NULL,          -- FK hacia cliente
    fecha       TIMESTAMPTZ DEFAULT NOW(),
    total       NUMERIC(10,2) NOT NULL,
    FOREIGN KEY (id_cliente) REFERENCES cliente (id_cliente)
);
```

- Un `cliente` puede tener **muchos** `pedido`.
- Cada `pedido` pertenece a **un solo** `cliente`.

Consulta de ejemplo:

```sql
-- Pedidos con los datos del cliente
SELECT
    c.id_cliente,
    c.nombre,
    p.id_pedido,
    p.fecha,
    p.total
FROM cliente c
JOIN pedido p
    ON c.id_cliente = p.id_cliente
ORDER BY c.id_cliente, p.id_pedido;
```

---

### 2.3 Relación Muchos a Muchos (N:M)

En una relación **N:M**:

- Varios registros de la tabla A se relacionan con varios registros de la tabla B.
- Se implementa mediante una **tabla intermedia** (tabla puente) con claves foráneas a ambas tablas.

#### Ejemplo: estudiante y curso

```sql
CREATE TABLE estudiante (
    id_estudiante  SERIAL PRIMARY KEY,
    nombre         VARCHAR(100) NOT NULL
);

CREATE TABLE curso (
    id_curso   SERIAL PRIMARY KEY,
    nombre     VARCHAR(100) NOT NULL
);

CREATE TABLE estudiante_curso (
    id_estudiante  INT NOT NULL,
    id_curso       INT NOT NULL,
    fecha_inscripcion DATE NOT NULL DEFAULT CURRENT_DATE,
    PRIMARY KEY (id_estudiante, id_curso),  -- PK compuesta
    FOREIGN KEY (id_estudiante) REFERENCES estudiante (id_estudiante),
    FOREIGN KEY (id_curso)      REFERENCES curso (id_curso)
);
```

- Un `estudiante` puede estar en **muchos** `curso`.
- Un `curso` puede tener **muchos** `estudiante`.

Consultas de ejemplo:

```sql
-- Cursos en los que está inscrito un estudiante
SELECT
    e.nombre AS estudiante,
    c.nombre AS curso
FROM estudiante e
JOIN estudiante_curso ec
    ON e.id_estudiante = ec.id_estudiante
JOIN curso c
    ON c.id_curso = ec.id_curso
WHERE e.id_estudiante = 1;

-- Estudiantes inscritos en un curso concreto
SELECT
    c.nombre AS curso,
    e.nombre AS estudiante
FROM curso c
JOIN estudiante_curso ec
    ON c.id_curso = ec.id_curso
JOIN estudiante e
    ON e.id_estudiante = ec.id_estudiante
WHERE c.id_curso = 1;
```

---

En resumen:

- Las **claves primarias** identifican filas de manera única.
- Las **claves foráneas** conectan tablas y mantienen la integridad.
- Las **relaciones 1:1, 1:N y N:M** permiten modelar correctamente las necesidades del negocio, apoyándose siempre en un buen diseño de claves y restricciones.